pipeline {
  agent any
  stages {
    stage('Clone Repository') {
      steps {
        sh '''
          echo "Starting repository clone..."
          git clone https://github.com/ayseyavas/webProje.git
          echo "Repository clone completed successfully"
        '''
      }
    }
    stage('Build Docker Image') {
      steps {
        sh '''
          echo "Starting Docker build..."
          docker build -t webProje .
          echo "Docker image built successfully"
        '''
      }
    }
    stage('Push Docker Image') {
      steps {
        sh '''
          echo "Starting Docker image push..."
          docker login -u $DOCKER_USER -p $DOCKER_PASS
          echo "Docker login successful"
          docker tag webProje ayseyavass/webProje:latest
          echo "Image tagged successfully"
          docker push ayseyavass/webProje:latest
          echo "Image pushed to Docker Hub successfully"
        '''
      }
    }
    stage('Deploy to Kubernetes') {
      steps {
        sh '''
          echo "Starting Kubernetes deployment..."
          helm upgrade --install webproje ./webProje-chart --namespace webproje
          echo "Helm deployment completed"
          
          echo "Checking pod status..."
          kubectl get pods -n webproje
          
          echo "Checking deployment details..."
          kubectl get deployments -n webproje
          
          echo "Checking service status..."
          kubectl get services -n webproje
          
          echo "Kubernetes deployment process completed"
        '''
      }
    }
    stage('Check Deployment Status') {
      steps {
        sh '''
          echo "Checking rollout status..."
          if kubectl rollout status deployment/webproje --timeout=300s; then
            echo "Deployment succeeded! Application is ready."
          else
            echo "Deployment failed! Check Kubernetes logs for details."
            exit 1
          fi
        '''
      }
    }
  }
  post {
    success {
      sh 'echo "Pipeline executed successfully! All stages completed."'
    }
    failure {
      sh 'echo "Pipeline failed! Check the logs above for errors."'
    }
  }
}